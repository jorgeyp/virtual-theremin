<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>tracking.js - color with camera</title>

	<script src="bower_components/jquery/dist/jquery.min.js"></script>
	<script src="bower_components/tracking/build/tracking-min.js"></script>
	<script src="js/MIDIUtils.js"></script>
	<link rel="stylesheet" type="text/css" href="bower_components/normalize-css/normalize.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="css/style.css">

</head>

<body>
	<!-- <div class="demo-title">
    <p><a href="http://trackingjs.com" target="_parent">tracking.js</a> － choose the colors you want to detect through the controls on the right</p>
  </div> -->

	<div id="container" class="container">

		<div class="content">
			<header id="header" class="header">
				<h1 id="title" class="title"> Virtual Theremin </h1>
			</header>
			<div id="sounds" class="sounds">
				<div class="row">
					<div class="col-md-3">
						<input type="submit" id="sine" class="btn btn-sound" data-sound="sine" value="Sine" onclick="setSound('sine');" />
					</div>
					<div class="col-md-3">
						<input type="submit" id="square" class="btn btn-sound" data-sound="square" value="Square" onclick="setSound('square');" />
					</div>
					<div class="col-md-3">
						<input type="submit" id="sawtooth" class="btn btn-sound" data-sound="sawtooth" value="Sawtooth" onclick="setSound('sawtooth');" />
					</div>
					<div class="col-md-3">
						<input type="submit" id="triangle" class="btn btn-sound" data-sound="triangle" value="Triangle" onclick="setSound('triangle');" />
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h2 id="note" class="pull-right"></h2>
					<h2 id="volume"></h2>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-2 col-md-2 col-xs-3">
					<input type="submit" id="record" class="btn btn-sound pull-left" data-sound="record" value="Record" onclick="record();" />
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<div class="center-block">
						<video id="video" width="1024" height="768" preload autoplay loop muted controls></video>
						<canvas id="canvas" width="1024" height="768"></canvas>
					</div>
				</div>
			</div>
		</div>



		<div id="content" class="content">
			<div class="demo-frame">
				<div class="demo-container">



					<div class="row">

						<div class="col-md-12">

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- <button id="play-sound" onclick="start();">Play sound</button>
	<button id="stop-sound" onclick="stop();">Stop sound</button>
  <h2 id="note"></h2>
  <h2 id="volume"></h2> -->

	<script>
		// Frecuencia del sonido
		var maxFreq = 3000;
		var minFreq = 65;
		var maxVol = 1;

		// Web Audio API
		var audioCtx = new AudioContext();
		var oscillator = audioCtx.createOscillator();
		var gainNode = audioCtx.createGain();

		oscillator.connect(gainNode);
		gainNode.connect(audioCtx.destination);

		oscillator.type = 'square'; // sine, square, sawtooth, triangle, custom
		oscillator.frequency.value = minFreq;
		oscillator.start();

		setVolume(0);

		var stopped = true;
		window.onload = function() {
			var video = document.getElementById('video');
			var canvas = document.getElementById('canvas');
			var context = canvas.getContext('2d');

			var tracker = new tracking.ColorTracker(['cyan', 'yellow']);

			tracking.track('#video', tracker, {
				camera: true
			});

			tracker.on('track', function(event) {
				context.clearRect(0, 0, canvas.width, canvas.height);

				if (event.data.length === 0) {
					// No targets were detected in this frame.
					stop();
				} else {
					// Plots the detected targets here.
					start();

					event.data.forEach(function(rect) { // Eventos de detección
						var vol = reverse(rect.y / canvas.height, maxVol, 0); // Volumen actual
						var freq = reverse(rect.y / canvas.height * maxFreq, maxFreq, minFreq); // Frecuencia actual

						if (rect.color === 'cyan') {
							// console.log(vol);
							setVolume(vol);
						}

						if (rect.color === 'yellow') {
							// console.log(freq);
							setFrequency(freq);
						}

						// Rectángulo alrededor de la detección
						context.strokeStyle = rect.color;
						context.strokeRect(rect.x, rect.y, rect.width, rect.height);
						// Mostrar coordenadas
						// context.fillStyle = "#fff";
						// context.fillText('x: ' + rect.x + 'px', rect.x + rect.width + 5, rect.y + 11);
						// context.fillText('y: ' + rect.y + 'px', rect.x + rect.width + 5, rect.y + 22);
					});
				}
			});
		};

		function frequencyToNote(freq) {
			return MIDIUtils.noteNumberToName(MIDIUtils.frequencyToNoteNumber(freq));
		}

		// Invertir valores, por las coordenadas
		function reverse(v, max, min) {
			return (max + min) - v;
		}

		function setVolume(vol) {
			gainNode.gain.value = vol;
			$('#volume').text(Number(vol * 100).toFixed() + "%");
		}

		function setFrequency(freq) {
			oscillator.frequency.value = freq;
			$('#note').text(frequencyToNote(freq));
		}

		function start() {
			setVolume(0.1);
		}

		function stop() {
			setVolume(0);
		}

		function setSound(waveForm) {
			oscillator.type = waveForm;
		}
	</script>

</body>

</html>
